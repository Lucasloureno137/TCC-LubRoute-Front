<div class="form-container">
  <div class="page-header">
    <div class="title-section">
      <h1 class="page-title">Incluir Produtos em Estoque</h1>
      <app-breadcrumb
        [items]="breadcrumbItems"
        [showContainer]="false"
      ></app-breadcrumb>
    </div>
  </div>

  <div class="content-card">
    <div class="form-section">
      <h3 class="form-title">Lançamento de Estoque</h3>

      <form class="form-grid">
        <mat-form-field class="form-field">
          <mat-label>Produto</mat-label>
          <input
            type="text"
            matInput
            [formControl]="myControl"
            [matAutocomplete]="auto"
            (focus)="carregarTodasOpcoes()"
          />
          <mat-autocomplete
            #auto="matAutocomplete"
            [displayWith]="displayFn"
            (optionSelected)="onProdutoChange($event.option.value)"
          >
            @for (option of filteredProdutos | async; track option) {
            <mat-option [value]="option">{{ option.nome }}</mat-option>
            }
          </mat-autocomplete>
        </mat-form-field>

        <mat-form-field class="form-field" *ngIf="false">
          <mat-label>Valor</mat-label>
          <input
            name="valor"
            currencyMask
            matInput
            type="text"
            [(ngModel)]="valor"
            [options]="{
              align: 'left',
              prefix: 'R$ ',
              thousands: '.',
              decimal: ',',
              allowNegative: false
            }"
          />
        </mat-form-field>

        <div>
          <span>Quantidade Atual:{{ produtoSelecionadoEstoqueAtual }}</span>
        </div>

        <mat-form-field class="form-field">
          <mat-label>Quantidade</mat-label>
          <input
            name="quantidade"
            matInput
            type="number"
            [(ngModel)]="quantidade"
            #quantidadeCtrl="ngModel"
            min="1"
            step="1"
            (click)="limparCampo($event)"
            (input)="corrigirQuantidade($event)"
          />
          <div
            *ngIf="quantidadeCtrl.invalid && quantidadeCtrl.touched"
            class="erro"
          >
            Quantidade deve ser maior ou igual a 1
          </div>
        </mat-form-field>

        <div class="tipos-lancamento">
          <label class="section-label">Tipo de lançamento: </label>
          <mat-radio-group [(ngModel)]="tipoLancamento" name="tipoLancamento">
            <mat-radio-button value="E"> Entrada </mat-radio-button>
            <mat-radio-button value="S" *ngIf="produtoSelecionadoEstoqueAtual && produtoSelecionadoEstoqueAtual > 0"> Saída </mat-radio-button>
          </mat-radio-group>
        </div>

        <div class="motivo">
        </div>
      </form>
    </div>

    <div class="form-actions">
      <app-voltar></app-voltar>
      <button class="btn-secondary" (click)="fileInput.click()">
        <i class="material-icons">upload_file</i>
        <span>Importar XML</span>
      </button>
      <input
        type="file"
        style="display: none"
        #fileInput
        (change)="abrirArquivo($event)"
        accept=".xml"
      />
      <button class="btn-primary" (click)="adicionarLista()">
        <i class="material-icons">add</i>
        <span>Adicionar a lista</span>
      </button>

      <button class="btn-primary" (click)="enviarFormulario()">
        <i class="material-icons">send</i>
        <span>Enviar</span>
      </button>
    </div>

    <div class="table-section" *ngIf="produtosLista.length > 0">
      <h3 class="form-title">Produtos Adicionados</h3>
      <table mat-table [dataSource]="produtosLista" class="mat-elevation-z8">
        <ng-container matColumnDef="nome">
          <th mat-header-cell *matHeaderCellDef>Nome</th>
          <td mat-cell *matCellDef="let element">{{ element.nome }}</td>
        </ng-container>

        <ng-container matColumnDef="quantidade">
          <th mat-header-cell *matHeaderCellDef>Quantidade</th>
          <td mat-cell *matCellDef="let element">{{ element.quantidade }}</td>
        </ng-container>

        <ng-container matColumnDef="valor">
          <th mat-header-cell *matHeaderCellDef>Valor</th>
          <td mat-cell *matCellDef="let element">{{ element.valor }}</td>
        </ng-container>

        <ng-container matColumnDef="codigo">
          <th mat-header-cell *matHeaderCellDef>Código</th>
          <td mat-cell *matCellDef="let element">{{ element.codigo }}</td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Ações</th>
          <td mat-cell *matCellDef="let element">
            <button
              mat-icon-button
              (click)="removerProduto(element)"
              class="delete-button"
            >
              <mat-icon>delete</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
      </table>
    </div>
  </div>
</div>
